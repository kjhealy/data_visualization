---
title: "Make Some Graphs"
author: "Kieran Healy"
date: "`r Sys.Date()`"
output: kjhslides::kjh_slides_reader
editor_options: 
  chunk_output_type: console
---

```{r note, include=FALSE}
## NB: By default the  template will create a new subdirectory with its files inside.
```


```{r packages, include=FALSE}
library(flipbookr)
library(here)
library(tidyverse)
library(kjhslides)
library(socviz)
library(gapminder)
```


```{r setup, include=FALSE}
## Configure the slides

kjh_register_tenso()    # Default fonts. Comment out if you don't have Tenso and Berkeley fonts.
kjh_set_knitr_opts()    
kjh_set_slide_theme()   # ggplot theme to go with slides. Set tenso = FALSE if necessary.
kjh_set_xaringan_opts()

```



class: center middle main-title section-title-1

# Make Some .kjh-yellow[Graphs] 

.class-info[

**Data Wrangling: Session 3**

.light[Kieran Healy<br>
Statistical Horizons, May 2022
]

]

---
layout: false
class: bottom
background-image: url("img/03_feed_me_seymour.png")
background-size: cover

## .huge.right.bottom.squish4.kjh-grey[Feed ggplot .kjh-pink[tidy] data]

---

layout: true
class: title title-1

---

# What is .kjh-orange[tidy data]?

.center[![:scale 50%](img/03_ggplot_tidy_data_only.png)]


---

# Every column is a single variable

.center[![:scale 50%](img/03_tidy_columns.png)]


---

# Every row is a single observation

.center[![:scale 50%](img/03_tidy_rows.png)]


---

# Every cell is a single value

.center[![:scale 50%](img/03_tidy_values.png)]


---

# Get your data into long format

Very, very often, the solution to some data-wrangling or data visualization problem in a Tidyverse-focused workflow is:

--

## First, get the data into long format.

## Then do the thing you want.

---

# Untidy data is common for good reasons!

Storing data in long format has a lot of _repetition_ and _redundancy_ in a printed table:

.small[
```{r 04-tidy-data-8 }
library(palmerpenguins)
penguins %>% 
  group_by(species, island, year) %>% 
  summarize(bill = round(mean(bill_length_mm, na.rm = TRUE),2)) %>% 
  knitr::kable()
```
]

---

# Untidy data is common for good reasons

Wide form is _easier_ and _more efficient_ to read in print:


.small[
```{r 04-tidy-data-9 }
penguins %>% 
  group_by(species, island, year) %>% 
  summarize(bill = round(mean(bill_length_mm, na.rm = TRUE), 2)) %>% 
  pivot_wider(names_from = year, values_from = bill) %>% 
  knitr::kable()
```
]

.tiny.footnote[(Again, these tables are made directly in R with the code you see here.)]


---

# It's also common for .kjh-orange[_less_] good reasons

.center[![:scale 85%](img/03_election_spreadsheet.png)]

---

# It's also common for .kjh-orange[_less_] good reasons

.pull-left[![:scale 100%](img/03_election_spreadsheet.png)]

.pull-right[

More than one header row

Mixed data types in some columns

Color and typography used to encode variables and their values
]
---


# Fix it .kjh-yellow[before] you import it

Prevention is better than cure!

An excellent article by Karl Broman and Kara Woo: 

- .smaller.squish3[Broman KW, Woo KH (2018) "[Data organization in spreadsheets](doi:10.1080/00031305.2017.1375989)." _The American Statistician_ 78:2â€“10]

.center[![:scale 40%](img/03_broman_and_woo.png)]

---

# The most common .kjh-orange[`tidyr`] operation

Pivoting:

.SMALL[
```{r 04-tidy-data-10 }
edu
```

The "Level of Schooling Attained" measure is spread across the columns, from `elem4` to `coll4`.


This is fine for a compact table, but for us it should be a single measure, say, "education". 
]
---

# From wide to long with .kjh-green[`pivot_longer()`]

.SMALL.squish2[We're going to put the columns `elem4:coll4` into a new column, creating a new categorical measure named `education`. The numbers currently under each column will become a  new .kjh-green[value] column corresponding to that level of education. ]

```{r 04-tidy-data-11 }
edu %>% 
  pivot_longer(elem4:coll4, names_to = "education")
```

---

# From wide to long with .kjh-green[`pivot_longer()`]

.SMALL.squish2[We can name the value column to whatever we like. Here it's a number of people.]

```{r 04-tidy-data-12 }
edu %>% 
  pivot_longer(elem4:coll4, names_to = "education", values_to = "n")
```


---

class: center middle main-title section-title-1

# .huge.kjh-lblue[How to get your own data into R]

---

# Reading in CSV files

CSV is not really a proper format at all!

--

Base R has .kjh-green[`read.csv()`]

--

Corresponding tidyverse "underscored" version: .kjh-green[`read_csv()`].

It is pickier and more talkative than the Base R version.

---

# Where's my data? Using .kjh-green[here()]

If we're loading a file, it's coming from _somewhere_.

If it's on our local disk somewhere, we will need to interact with the file system. We should try to do this in a way that avoids _absolute_ file paths. 

```r
# This is not portable
df <- read_csv("/Users/kjhealy/Documents/data/misc/project/data/mydata.csv")
```

--
  
We should also do it in a way that is _platform independent_. 

This makes it easier to share your work, move it around, etc. Projects should be self-contained.

---

# Where's my data? Using .kjh-green[here()]

The `here` package, and .kjh-green[**`here()`**] function builds paths relative to the top level of your R project. 

```{r 06-getting-data-in-3 }
here() # this path will be different for you
```

---

# Where's the data? Using .kjh-green[here()]

This seminar's files all live in an RStudio project. It looks like this:

```{r 06-getting-data-in-4, echo = FALSE}
fs::dir_tree(here(), recurse = 0)
```

I want to load files from the `data` folder, but I also want _you_ to be able to load them. I'm writing this from somewhere deep in the `slides` folder, but you won't be there. Also, I'm on a Mac, but you may not be.

---

# Where's the data? Using .kjh-green[here()]

 So:

```{r 06-getting-data-in-5 }
## Load the file relative to the path from the top of the project, without separators, etc
organs <- read_csv(file = here("data", "organdonation.csv"))
```

--
.SMALL[

```{r 06-getting-data-in-6 }
organs
```

]

.small[And there it is.]

---

# .kjh-green[`read_csv()`] comes in different varieties


## .kjh-green[**`read_csv()`**] Field separator is a comma: .kjh-red[**`,`**]

```{r 06-getting-data-in-7 }
organs <- read_csv(file = here("data", "organdonation.csv"))
```

## .kjh-green[**`read_csv2()`**] Field separator is a semicolon: .kjh-red[**`;`**]

```r
# Example only
my_data <- read_csv2(file = here("data", "my_euro_file.csv))
```

Both are special cases of .kjh-green[**`read_delim()`**]

---

# Other species are also catered to

- .kjh-green[**`read_tsv()`**] Tab separated.

- .kjh-green[**`read_fwf()`**] Fixed-width files.

- .kjh-green[**`read_log()`**] Log files (i.e. computer log files).

- .kjh-green[**`read_lines()`**] Just read in lines, without trying to parse them.

---

# Also often useful ...

- .kjh-green[**`read_table()`**]  

For data that's separated by one (or more) columns of space.


---

# And for foreign file formats ... 

## The tidyverse's .kjh-lblue[`haven`] package provides

- .kjh-green[**`read_dta()`**]  Stata

- .kjh-green[**`read_spss()`**]  SPSS

- .kjh-green[**`read_sas()`**]  SAS

- .kjh-green[**`read_xpt()`**]  SAS Transport


## Make these functions available with .kjh-green[`library`]`(haven)`

---

# You can read files remotely, too

.SMALL.squish3[
You can give all of these functions local files, or they can point to URLs.

Compressed files will be automatically uncompressed.

(Be careful what you download from remote locations!)]

.SMALL[
```{r 06-getting-data-in-8 }
organ_remote <- read_csv("http://kjhealy.co/organdonation.csv")

organ_remote
```
]

---

class: center middle main-title section-title-1

# .huge.kjh-lblue[How .kjh-yellow[ggplot] works]

---

# ggplot's flow of action

.center[![:scale 90%](img/03_ggplot_flow_wide_all.png)]


---

# ggplot's flow of action

.center[![:scale 50%](img/03_ggplot_flow_tidy_data_only.png)]


---

# ggplot's flow of action

.center[![:scale 50%](img/03_ggplot_flow_final_plot_only.png)]

---

# ggplot's flow of action

.center[![:scale 90%](img/03_ggplot_flow_wide_all.png)]

---

# ggplot's flow of action

.center[![:scale 100%](img/03_ggplot_flow_wide_1to3.png)]

---

# ggplot's flow of action

.center[![:scale 100%](img/03_ggplot_flow_wide_4to6.png)]


---

# ggplot's flow of action: .kjh-red[required]

.center[![:scale 40%](img/03_ggplot_flow_wide_1.png)]


---

# ggplot's flow of action: .kjh-red[required]

.center[![:scale 40%](img/03_ggplot_flow_wide_2.png)]


---

# ggplot's flow of action: .kjh-red[required]

.center[![:scale 35%](img/03_ggplot_flow_wide_3.png)]

---

class: right bottom main-title section-title-1

## .huge.right.bottom.squish4.kjh-yellow[Let's go piece by piece]


---

# Start with the data

```{r}
gapminder
```

```{r}
dim(gapminder)
```

---

# Create a plot object

## Data is the `gapminder` tibble.

```{r 03-make-a-plot-3}
p <- ggplot(data = gapminder)
```

## Map variables to aesthetics

## Tell ggplot the variables you want represented by visual elements on the plot

```{r 03-make-a-plot-4}
p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap,
                          y = lifeExp))
```

---

# Map variables to aesthetics

## The `mapping = aes(...)` call links variables to things you will see on the plot.

## `x` and `y` represent the quantities determining position on the x and y axes.

## Other aesthetic mappings can include, e.g., `color`, `shape`, `size`, and `fill`. 

---
layout: false
class: main-title main-title-inv

## .middle.large.squish4[.kjh-orange[Mappings] do not _directly_ specify the particular, e.g., colors, shapes, or line styles that will appear on the plot. Rather, they establish _which variables_ in the data will be represented by _which visible elements_ on the plot.]

---

layout: true
class: title title-1

---

# Our plot has mappings but no geom

```{r 03-make-a-plot-5, fig.cap='This empty plot has no geoms.', fig.width=8, fig.height=5}
p
```

---

# Add a geom

```{r 03-make-a-plot-6, fig.cap='A scatterplot of Life Expectancy vs GDP', fig.width=8, fig.height=5}
p + geom_point() 
```

---

# Try a different geom

```{r, fig.cap='A scatterplot of Life Expectancy vs GDP', fig.width=8, fig.height=5}
p + geom_smooth() 
```

---

# Build your plots layer by layer

```{r, fig.cap='Life Expectancy vs GDP, using a smoother.', fig.width=8, fig.height=5}

p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap,
                          y=lifeExp))
p + geom_smooth()

```


---

# This process is additive

```{r, fig.cap='Life Expectancy vs GDP, using a smoother.', fig.width=8, fig.height=5}

p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap,
                          y=lifeExp))
p + geom_point() + geom_smooth()

```

---
`r chunk_reveal("reveal-additive1", widths = c(35,65), title = "# This process is additive")`

```{r reveal-additive1, include = FALSE}
p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap,
                          y=lifeExp))
p + geom_smooth() + 
  geom_point() 
```
---

# Every .kjh-green[`geom`] is a .kjh-green[function] 

## Functions take arguments

.pull-left.w45[
```{r codefig-functionargs, message=FALSE, fig.show="hide", fig.cap="An ill-advised linear fit", fig.width=4.8, fig.height=4.5}
p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap,
                          y=lifeExp))
p + geom_point() + 
  geom_smooth(method = "lm") 
```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-functionargs", "png"))
```
]

---
`r chunk_reveal("reveal-logtrans", widths = c(40,60), title = "# Keep Layering")`

```{r reveal-logtrans, include = FALSE}
 p <- ggplot(data = gapminder, 
             mapping = aes(x = gdpPercap, 
                           y=lifeExp))
p + geom_point() +
    geom_smooth(method = "lm") +
    scale_x_log10()
```
---

`r chunk_reveal("reveal-logtrans2", widths = c(50,50), title = "# Fix the labels")`

```{r reveal-logtrans2, include = FALSE}
p <- ggplot(data = gapminder, 
            mapping = aes(x = gdpPercap, 
                          y=lifeExp))
p + geom_point() +
    geom_smooth(method = "lm") +
    scale_x_log10(labels = scales::dollar_format())
```

---

# Add labels, title, and caption

.pull-left.w45[
```{r codefig-logtranslab, message=FALSE, fig.show="hide", fig.width=5, fig.height=4.5}
p <- ggplot(data = gapminder, 
            mapping = aes(x = gdpPercap, 
                          y = lifeExp))
p + geom_point() + 
  geom_smooth(method = "lm") +
    scale_x_log10(labels = scales::dollar_format()) +
    labs(x = "GDP Per Capita", 
         y = "Life Expectancy in Years",
         title = "Economic Growth and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.")
```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-logtranslab", "png"))
```
]

---

class: right bottom main-title section-title-1

## .huge.right.bottom.squish4[.kjh-yellow[Mapping] vs .kjh-lblue[Setting]<br />your plot's aesthetics]



