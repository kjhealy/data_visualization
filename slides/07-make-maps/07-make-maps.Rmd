---
title: "07 - Make Maps"
author: "Kieran Healy"
date: "`r Sys.Date()`"
output: kjhslides::kjh_slides_reader
editor_options: 
  chunk_output_type: console
---

```{r note, include=FALSE}
## NB: By default the  template will create a new subdirectory with its files inside.
```


```{r packages, include=FALSE}
library(flipbookr)
library(here)
library(tidyverse)
library(kjhslides)
```


```{r setup, include=FALSE}
## Configure the slides

kjh_register_tenso()    # Default fonts. Comment out if you don't have Tenso and Berkeley fonts.
kjh_set_knitr_opts()    
kjh_set_slide_theme()   # ggplot theme to go with slides. Set tenso = FALSE if necessary.
kjh_set_xaringan_opts()

```



class: center middle main-title section-title-1

# .kjh-yellow[Making] .kjh-lblue[Maps]

.class-info[

**Data Visualization: Session 7**

.light[Kieran Healy<br>
Code Horizons, May 2022
]

]

---

layout: true
class: title title-1

---

# Load our libraries

```{r 03a-dplyr-basics-2, message = FALSE}
library(here)      # manage file paths
library(socviz)    # data and some useful functions
library(tidyverse) # your friend and mine
library(maps)      # Some basic maps
library(sf)        # Simple Features Geometries and geom_sf()
library(ggforce)   # Useful enhancements to ggplot
```

---

class: center middle main-title section-title-1

# .huge[.kjh-lblue[Choropleths]]


---
layout: false

.center[![:scale 75%](img/07_election_state_1.png)]

.right.w90.small[State-level; vote share; diverging; binned into four categories.]


---
layout: false

.center[![:scale 75%](img/07_election_county.png)]

.right.w90.small[County level; winner only]

---
layout: false

.center[![:scale 75%](img/07_election_county_share.png)]

.right.w90.small[County level vote share; diverging; binned into six categories]

---
layout: false

.center[![:scale 75%](img/07_election_county_purple.png)]

.right.w90.small[County level vote share; diverging continuous; purple midpoint]

---
layout: false

.center[![:scale 75%](img/07_election_county_purple_pop.png)]

.right.w90.small[County level vote share; purple midpoint; county area deformed in proportion to population. By Mark Newman]

---
layout: false

.center[![:scale 60%](img/07_election_electoral_college_cartogram.png)]

.right.w90.small[Electoral college cartogram]

---

layout: true
class: title title-1

---
layout: false
class: main-title main-title-inv middle

# .middle.squish4.medium[.kjh-lblue[Problems showing] .kjh-orange[Non-Spatial Data]<br /> .kjh-lblue[in choropleth maps]]

---

.center[![:scale 75%](img/07_federal_lands_cred_sm.png)]

.right.w90.big[Pretty, Big, and Pretty Empty]

---

.center[![:scale 70%](img/07_federal_lands_admin_sm.png)]

.right.w90.big[Pretty, Big, and Pretty Empty]


---

layout: true
class: title title-1

---


# Aside: What the hell's that?

.center[![:scale 80%](img/07_nevada_sm_clip.png)]

---

# Zoom and Enhance

.center[![:scale 90%](img/07_federal_checkerboard_sm.png)]

.center.large[Suprisingly, not a coding error on my part.]

---

# It's the .kjh-pink[Transcontinental Railroad]

.center[![:scale 50%](img/07_trans_pacific_route.png)]

.center.medium[Making its way through the .kjh-lblue[Great Basin], America's largest .kjh-orange[endorheic watershed]. The checkerboard is a deliberate assignation of property rights along the borders of the railway line.]
---

# Still with us, too

.center[![:scale 60%](img/07_interstate_80_route.png)]

.center.medium[Not identical, as Interstate 80 was able to go through some parts the railroad had to go around. OK, now back to scheduled programming.]


---

layout: true
class: title title-1

---

class: right bottom main-title section-title-1

## .huge.right.bottom.squish4[.kjh-yellow[U.S. State-Level]<br />.kjh-lblue[Election Data]]

---

# Set up the data

```{r}
## Hex color codes for Democratic Blue and Republican Red
party_colors <- c("#2E74C0", "#CB454A")
```


```{r}
election |> 
  select(state, total_vote, r_points, pct_trump, party, census)
```

---
`r chunk_reveal("reveal-elecfacet1", widths = c(45,55), title = "# Look before Mapping")`

```{r reveal-elecfacet1, include = FALSE}

election |> 
  filter(st %nin% "DC") |> 
  ggplot(mapping = aes(x = r_points,
                       y = reorder(state, r_points),
                       color = party)) + 
  geom_vline(xintercept = 0, 
             color = "gray30") +
  geom_point(size = 2) + 
  scale_color_manual(values = party_colors) + 
  scale_x_continuous(breaks = c(-30, -20, -10, 0, 
                                10, 20, 30, 40),
                     labels = c("30\n (Clinton)", 
                                "20", "10", "0",
                                "10", "20", "30", 
                                "40\n(Trump)")) + 
  facet_wrap(~ census, ncol=2, 
             scales="free_y") +
  guides(color = "none") + 
  labs(x = "Point Margin", y = NULL) +
    theme(axis.text=element_text(size=8))


```

---

layout: true
class: title title-1

---

# With a bit more room

.pull-left.w60[

```{r, echo = FALSE, fig.height=6, fig.width=8}
p_out <- election |> 
  filter(st %nin% "DC") |> 
  ggplot(mapping = aes(x = r_points,
                       y = reorder(state, r_points),
                       color = party)) + 
  geom_vline(xintercept = 0, 
             color = "gray30") +
  geom_point(size = 2) + 
  scale_color_manual(values = party_colors) + 
  scale_x_continuous(breaks = c(-30, -20, -10, 0, 
                                10, 20, 30, 40),
                     labels = c("30\n (Clinton)", 
                                "20", "10", "0",
                                "10", "20", "30", 
                                "40\n(Trump)")) + 
  facet_wrap(~ census, ncol=2, 
             scales="free_y") +
  guides(color = "none") + 
  labs(x = "Point Margin", y = NULL) +
    theme(axis.text=element_text(size=8))

p_out
```

]

--

.pull-right.w40[

- See how the panels are unbalanced, even with `scales = "free_y"`?

- This happens because we have unequal number of states per region.

]


---

# We can use .kjh-green[`facet_col()`] from .kjh-lblue[`ggforce`]


.pull-left.w45[
```{r codefig-ggforce, message=FALSE, fig.show="hide", fig.width=2.5, fig.height=5.65}

p_out <- election |> 
  filter(st %nin% "DC") |> 
  ggplot(mapping = aes(x = r_points,
                       y = reorder(state, r_points),
                       color = party)) + 
  geom_vline(xintercept = 0, 
             color = "gray30") +
  geom_point(size = 2) + 
  scale_color_manual(values = party_colors) + 
  scale_x_continuous(breaks = c(-30, -20, -10, 0, 
                                10, 20, 30, 40),
                     labels = c("30\n (Clinton)", 
                                "20", "10", "0",
                                "10", "20", "30", 
                                "40\n(Trump)")) + 
  facet_col(~ census, #<<
            scales="free_y", #<<
            space = "free") + #<<
  guides(color = "none") + 
  labs(x = "Point Margin", y = NULL) +
    theme(axis.text=element_text(size=6), 
          strip.text = element_text(size = rel(0.6)))

p_out

```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-ggforce", "png"))
```
]

---

class: center middle main-title section-title-1

# .huge[.kjh-lblue[Basic] .kjh-yellow[Maps]]

---

class: right bottom main-title section-title-1

## .huge.right.bottom.squish4[.kjh-yellow[Maps as] .kjh-lblue[polygons]]

---

layout: true
class: title title-1

---

# Take a look at this data

```{r}
## This is from the map library
# library(maps)

us_states <- map_data("state")

dim(us_states)

## Making it a tibble prevents crashes 
## in the slide rendering later on
us_states <- as_tibble(us_states)

us_states

```

---

# What is this, at root?

```{r}
us_states

```

- It's a series of rows defining `x` and `y` coordinatates on a plane. 

- If we join those points up as lines while respecting their `group` (i.e. so `ggplot` knows when to "lift the pen", as with the `gapminder` line plot), we will get an outline map of states in the U.S. 

---

# Like this, with .kjh-green[`geom_polygon()`]

.pull-left.w35[
```{r codefig-poly1, message=FALSE, fig.show="hide", fig.width=6, fig.height=4.5}
  
us_states |> 
  ggplot(mapping = aes(x = long, 
                       y = lat, 
                       group = group)) +
  geom_polygon(fill = "white", 
               color = "black") +
  labs(title = "This looks horrible")

```
]

--

.pull-right.w65[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-poly1", "png"))
```
]

---

# We can represent a .kjh-orange[`fill`], too, like any geom


.pull-left.w35[
```{r codefig-poly2, message=FALSE, fig.show="hide", fig.width=6, fig.height=4.5}

us_states |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = region,#<<
                       group = group)) +
  geom_polygon(color = "black") + 
  guides(fill = "none") + #<<
  labs(title = "Still looks horrible", 
       caption = "Set fill = none 
         to stop ggplot from 
         producing a key
         with 50 entries")

```
]

--

.pull-right.w65[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-poly2", "png"))
```
]

---

layout: true
class: title title-1

---

# We need to do two things

### .center.middle.huge[1: Fix the .kjh-lblue[map projection]]

### .center.middle.huge[2: .kjh-orange[Add some data] to fill with.]

---

# For now, we'll do it the direct way

- .middle.large[To make explicit what's happening, and to emphasize how .kjh-pink[_it's all just points and lines made from tables_] we'll first do it at the level of the .kjh-lblue[`ggplot`] grammar with a geom that just draws shapes, .kjh-green[`geom_polygon()`]. After that, we'll introduce a new package, .kjh-lblue[`sf`] and a new geom, .kjh-green[`geom_sf()`] that will handle this for us, and more.]

---

layout: true
class: title title-1

---

`r chunk_reveal("reveal-coord", widths = c(35,65), title = "# Fix the projection")`

```{r reveal-coord, include = FALSE}

us_states |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = region,
                       group = group)) +
  geom_polygon(color = "black") + 
  guides(fill = "none") +
  coord_map(projection = "albers", 
            lat0 = 39, 
            lat1 = 45) 

## A coordinate transformation!

```

---

layout: true
class: title title-1

---

# U.S. Map Projections

.center[![:scale 70%](img/07_four_us_projections.png)]


---

# U.S. Map Projections

.center[![:scale 70%](img/07_us_albers.png)]

---
layout: false

```{r, echo = FALSE, fig.height=8, fig.width=15}
us_states |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = region,#<<
                       group = group)) +
  geom_polygon(color = "black") + 
  coord_map(projection = "albers", #<
            lat0 = 39,  #<
            lat1 = 45) + #<
  guides(fill = "none")
```


.right.w90.small[Our U.S. Map again, now transformed]

---

layout: true
class: title title-1

---

# Next, some data

.small[- We can merge our state-level `election` data with the `us_states` table, but we need to do a little work.] 

.pull-left.w45[
```{r}
us_states
```

]

.pull-right.w45[
```{r}
election
```
]

--

.center[To merge, or .kjh-pink[_join_] these tables, they need to have a column in common to act as a key.]


---

# Recode to make a key

```{r}
election <- election |> 
  mutate(region = tolower(state)) |> 
  relocate(region)

election
```

---

# Now we can join them

.pull-left.w45[
```{r}
us_states
```

]

.pull-right.w45[
```{r}
election
```
]

---

# This is a .kjh-pink[_left join_]

```{r}
us_states_elec <- left_join(us_states, election)

us_states_elec
```

--

.center[Now our `us_states_elec` table has both the line-drawing information and (very redundantly) the election data merged in, with rows repeated as necessary.]


---

layout: true
class: title title-1

---

# Now we can start drawing choropleths


.pull-left.w45[
```{r codefig-choroparty, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = party,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  guides(fill = "none")


```
]

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-choroparty", "png"))
```

]

---

# Let's turn off the gridlines

This is a .kjh-pink[_theme function_].

```{r}
theme_map <- function(base_size=9, base_family="") {
    require(grid)
    theme_bw(base_size=base_size, base_family=base_family) %+replace%
        theme(axis.line=element_blank(),
              axis.text=element_blank(),
              axis.ticks=element_blank(),
              axis.title=element_blank(),
              panel.background=element_blank(),
              panel.border=element_blank(),
              panel.grid=element_blank(),
              panel.spacing=unit(0, "lines"),
              plot.background=element_blank(),
              legend.justification = c(0,0),
              legend.position = c(0,0)
              )
}
```

---

# Add the theme function at the end

.pull-left.w45[
```{r codefig-choropartytheme, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = party,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  theme_map()


```
]

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-choropartytheme", "png"))
```

]

---

# Fix the Party Colors


.pull-left.w45[
```{r codefig-choropartycolors, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}
  
## recall
party_colors

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = party,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  scale_fill_manual(values = party_colors) + 
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  theme_map()

```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-choropartycolors", "png"))
```
]

---

# On maps, continuous measures are _gradients_


.pull-left.w45[
```{r codefig-gradient1, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = pct_trump,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  labs(title = "Trump vote", 
       fill = "Percent") +  
  theme_map()

```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-gradient1", "png"))
```
]

---

# Fix the gradient scale with its .kjh-orange[scale function]


.pull-left.w45[
```{r codefig-gradient2, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = pct_trump,
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  scale_fill_gradient(low = "white",  #<<
                      high = "#CB454A") + #<<
        labs(title = "Trump vote") +
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  labs(title = "Trump vote", 
       fill = "Percent") +  
  theme_map()


```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-gradient2", "png"))
```


]

---

# Some gradients are .kjh-yellow[_diverging_]


.pull-left.w45[
```{r codefig-diverging1, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = d_points,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  scale_fill_gradient2() + #<<
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  labs(title = "Winning Margins", 
       fill = "Percent") +  
  theme_map()


```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-diverging1", "png"))
```

]

---

# Purple America Map


.pull-left.w45[
```{r codefig-purpleamerica, message=FALSE, fig.show="hide", fig.width=4.8, fig.height=4.5}

us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = d_points,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  scale_fill_gradient2(low = "red",#<<
                mid = scales::muted("purple"),#<<
                high = "blue",#<<
                breaks = c(-25, 0, 25, #<<
                        50, 75)) + #<<
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  labs(title = "Winning Margins", 
       fill = "Percent") +  
  theme_map()



```
]

--

.pull-right.w55[
```{r, echo=FALSE}
  knitr::include_graphics(
  knitr::fig_chunk("codefig-purpleamerica", "png"))
```
]

---
layout: false

```{r, echo = FALSE, fig.width=12, fig.height=7}
us_states_elec |> 
  ggplot(mapping = aes(x = long, 
                       y = lat,
                       fill = d_points,#<<
                       group = group)) + 
  geom_polygon(color = "gray90", 
               size = 0.1) +
  scale_fill_gradient2(low = "red",#<<
                mid = scales::muted("purple"),#<<
                high = "blue",#<<
                breaks = c(-25, 0, 25, #<<
                        50, 75)) + #<<
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  labs(title = "Winning Margins", 
       fill = "Percent") +  
  theme_map()

```


.right.w90.small[Take a closer look]





